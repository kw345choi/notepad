// davis.js JavaScript Routing, version: 0.4.0
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(c){var d=new Davis.App;c.call(d);return d};Davis.supported=function(){return typeof window.history.pushState=="function"};Davis.noop=function(){};Davis.toArray=function(c,d){return Array.prototype.slice.call(c,d||0)};
Davis.listener=function(){var c=function(b){return function(){var e=new Davis.Request(b.call(jQuery(this)));Davis.history.pushState(e);return false}},d=c(function(){var b=this;return{method:"get",fullPath:this.attr("href"),title:this.attr("title"),delegateToServer:function(){window.location.pathname=b.attr("href")}}}),a=c(function(){var b=this;return{method:this.attr("method"),fullPath:[this.attr("action"),function(e){return e.serializeArray().map(function(h){return[h.name,h.value].join("=")}).join("&")}(this)].join("?"),
title:this.attr("title"),delegateToServer:function(){b.submit()}}});return{listen:function(){jQuery(document).delegate(this.settings.formSelector,"submit",a);jQuery(document).delegate(this.settings.linkSelector,"click",d)},unlisten:function(){jQuery(document).undelegate(this.settings.linkSelector,"click",d);jQuery(document).undelegate(this.settings.formSelector,"submit",a)}}}();
Davis.event={_callbacks:{},bind:function(c,d){this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(d);return this},trigger:function(c){var d=this,a=arguments;this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].forEach(function(b){b.apply(d,Davis.toArray(a,1))});return this}};
Davis.logger=function(){var c=function(d){d=Davis.toArray(d);d.unshift("["+Date()+"]");return d};return{error:function(){window.console&&console.error.apply(console,c(arguments))},info:function(){window.console&&console.info.apply(console,c(arguments))},warn:function(){window.console&&console.warn.apply(console,c(arguments))}}}();
Davis.Route=function(){var c=/:([\w\d]+)/g,d=function(a,b,e){this.paramNames=function(){for(var f=[],g;g=c.exec(b);)f.push(g[1]);return f}();var h;h=b instanceof RegExp?b:RegExp("^"+b.replace(c,"([^/]+)")+"$","gi");this.path=h;this.method=a instanceof RegExp?a:RegExp("^"+a+"$","i");this.callback=e};d.prototype={match:function(a,b){this.reset();return this.method.test(a)&&this.path.test(b)},reset:function(){this.method.lastIndex=0;this.path.lastIndex=0},run:function(a){this.reset();var b=this.path.exec(a.path);
if(b){b.shift();for(var e=0;e<b.length;e++)a.params[this.paramNames[e]]=b[e]}return this.callback.call(a,a)},toString:function(){return[this.method,this.path].join(" ")}};return d}();
Davis.router=function(){var c=this;["get","post","put"].forEach(function(d){c[d]=function(a,b){c._routeCollection.push(new Davis.Route(d,a,b))}});this.del=function(d,a){c._routeCollection.push(new Davis.Route("delete",d,a))};this.state=function(d,a){c._routeCollection.push(new Davis.Route("state",d,a))};this.trans=function(d,a){var b=a?[d,decodeURIComponent($.param(a))].join("?"):d;b=new Davis.Request({method:"state",fullPath:b,title:""});Davis.history.pushState(b)};["before","after"].forEach(function(d){c[d]=
function(){if(arguments.length==1)var b=/.+/,e=arguments[0];else if(arguments.length==2){b=arguments[0];e=arguments[1]}c._filterCollection[d].push(new Davis.Route(/.+/,b,e))};var a="lookup"+d.replace(/^\w/,function(b){return b.toUpperCase()})+"Filter";c[a]=function(b,e){return c._filterCollection[d].filter(function(h){return h.match(b,e)})}});c._routeCollection=[];c._filterCollection={before:[],after:[]};c.lookupRoute=function(d,a){return this._routeCollection.filter(function(b){return b.match(d,
a)})[0]}};Davis.history=function(){var c=[],d=true,a=function(b){return function(e){if(e.state){e=e.state;e.__proto__=Davis.Request.prototype;b(e)}else d||b(Davis.Request.forPageLoad());d=false}};return{replaceState:function(b){history.replaceState(b,b.title,b.location());c.forEach(function(e){e(b)})},pushState:function(b){history.pushState(b,b.title,b.location());c.forEach(function(e){e(b)})},onChange:function(b){c.push(b);b=a(b);window.addEventListener("popstate",b,true)}}}();
Davis.Request=function(c){var d=this;this.params={};this.title=c.title;this.queryString=c.fullPath.split("?")[1];this._staleCallback=function(){};this.queryString&&this.queryString.split("&").forEach(function(a){var b=a.split("=")[0];a=a.split("=")[1];var e;if(e=/^(\w+)\[(\w+)\]/.exec(b)){var h=e[1];b=e[2];e=d.params[h]||{};e[b]=a;d.params[h]=e}else d.params[b]=a});this.method=(this.params._method||c.method).toLowerCase();this.path=c.fullPath.replace(/\?.+$/,"");this.delegateToServer=c.delegateToServer||
Davis.noop;Davis.Request.prev&&Davis.Request.prev.makeStale(this);Davis.Request.prev=this};Davis.Request.prototype.redirect=function(c){Davis.history.replaceState(new Davis.Request({method:"get",fullPath:c,title:this.title}))};Davis.Request.prototype.whenStale=function(c){this._staleCallback=c};Davis.Request.prototype.makeStale=function(c){this._staleCallback.call(c,c)};Davis.Request.prototype.location=function(){return this.method==="get"?this.path:""};
Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:window.location.pathname,title:document.title})};Davis.Request.prev=null;
Davis.App=function(){var c=0,d=function(){this.id=[(new Date).valueOf(),c++].join("-");this.boundToInternalEvents=this.running=false};d.prototype=jQuery.extend({configure:function(a){a.call(this.settings)},use:function(a){a.apply(this,Davis.toArray(arguments,1))},helpers:function(a){for(property in a)if(a.hasOwnProperty(property))Davis.Request.prototype[property]=a[property]},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger,throwErrors:true,handleRouteNotFound:false,generateRequestOnPageLoad:true},
start:function(){var a=this;if(Davis.supported()){var b=function(f){return function(g){g=g.run(f,f);return typeof g==="undefined"||g}},e=function(f){if(a.lookupBeforeFilter(f.method,f.path).every(b(f))){a.trigger("lookupRoute",f);var g=a.lookupRoute(f.method,f.path);if(g){a.trigger("runRoute",f,g);try{g.run(f);a.trigger("routeComplete",f,g)}catch(i){a.trigger("routeError",f,g,i)}a.lookupAfterFilter(f.method,f.path).every(b(f))}else a.trigger("routeNotFound",f)}else a.trigger("requestHalted",f)},h;
this.boundToInternalEvents||function(){a.bind("runRoute",function(f){a.settings.logger.info("runRoute: "+f.toString())}).bind("routeNotFound",function(f){if(!a.settings.handleRouteNotFound){a.stop();f.delegateToServer()}a.settings.logger.warn("routeNotFound: "+f.toString())}).bind("start",function(){a.settings.logger.info("application started")}).bind("routeError",function(f,g,i){if(a.settings.throwErrors)throw i;a.settings.logger.error(i.message,i.stack)});Davis.history.onChange(function(f){e(f)});
a.boundToInternalEvents=true}();this.listen();this.trigger("start");this.running=true;this.settings.generateRequestOnPageLoad&&e(Davis.Request.forPageLoad())}else this.trigger("unsupported")},stop:function(){this.unlisten();this.trigger("stop");this.running=false}},Davis.listener,Davis.event);Davis.router.call(d.prototype);return d}();